language: python

python:
  - "3.5"

env:
  global:
    - secure: M24+QrJ6poqTyVjbIq7n9riUpz5kDlsj/wcBgDAhT2Ll39zsLmhF4NeGWDo7aGTcC9eTUI5HZQhyS40ZbTItr3OSI1nkeSFBF6/2VGp+AOjaVQQGHoSC22sKawENBWl/vcXIVprPrEPp6i7tKKAHNj8G5oQKFNImVg88KIrX7YIa/lxzUDd3lG7JLBJ3brO8exrLfszPo0i5ixcSYWUAzyk0w9e/uwNbgYRw84Ve97QHPM+gJoFWe4LfnJzhnVEj7qxPWGHBgmkah9hk48ETYuBqW/4JffU/ZW5ytF7EJ0lmBP1Dc7dXYEHJ2EgFdNsOvSU4CQU6BewVv/JrRLqPwcsPxf7rd9f1FRaD2A2FecLKFHTzc9TTl3B6qMQeNpnk41Hib/x4FBNsQWCqa5XYbSyu0KC6tOi+jnWqgZeJlt/YMrYA8584FZPZRhpWXzaC34YRYVQkJigzo/ORnDR2BxJ7HeSfwhBad/0eDVatsC3Z2/0xcjd7+NZkHyfJLZB45D+Mr1+DuwoiOnTPcxYooPF8RAYe206empi1m3qFYpf/ZtNxB2mIkiIb7EibI6b3zOlAkg2UsV3Hi/k0XyyCQXdSgmZxYFlbhZTfr2PIcxBCKeSfJx8AC4P4NAmEPExArJJW/3W0VC/V7z0aXHLwuG3vmrgUzFbMWKLtjPFU5ls=
    - secure: GjFLQBXR5d6LLEarqfyKE/rnftJWLWks/zJ4ltgafl8Gp5vbw+fjbvlNMHn7B8bnCGmsAcKdKJ1ZohNKtHyf9+uV1XiHf3hNaq0NhxVE7Vo7PgsByTE74bWD7+537O0cNqmHUFaJMf/jJqMq7pG+VxCduSiQzwEy6FmuQN72Yv2ed1VyOwUnEgq80U7kNW9Qcq6IWQXUIzqwPqUd7P6l35baHI4eWjWOd4CbvdN0sipVw1kToUh0TIIK0zac8NrbwryDaAL//grJQOuHEUo1A83b4hE3k8Iw7MdnAK35j6iUfv+oK8DEbszLG78smdYDJDJneO8GBHiMNFEL1KhdL5+mDsqSx+zpkgXfTOjZX6ROmd4Nb5DLNUfFZmb0uEKgpRXNE/MYAUKFt0NmF76pP8zupzTsTFwLKwsuRcBUeKq6iKjTgpKHFlkaCuohDbUAIcrOy1qWrUq8xzZJemZ0siWOI+sHZJcum576z0M7GkAX0+9vXrqAvCVAyOLaU2fpZKxcRQP9ma8FvWcvi9CgecMpKQ8KUKYGG0mOIku03QFC9ltSbOmVLX8WmKb4Frpoxtdit7qR9NHs3sZK2STZxssEgqR1raPEXnkPBbX2mpEhD3Pi17Hd5FZWOaUZhJuMt7v9yzrwFJ8CPy9vdqU0F2aexeKqii1Lrxa0ypxzIWs=

sudo: required

services:
  - docker

cache:
  - pip

before_install:
  # Confirm Docker version and login credentials
  - docker --version
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"

  # Upgrade Docker
  - sudo apt-get -y update
  - sudo apt-get -y install -o Dpkg::Options::="--force-confnew" docker-ce
  - docker --version

  # Build the image
  - docker-compose build

  # Ensure we have a place to store coverage output
  - mkdir -p coverage

  # Bring everything online
  - make up-test

# Do NOT install Python requirements.
# Doing so is a waste of time since they won't be used.
install: true

script:
  - make exec-validate-translations
  - make exec-quality
  - make exec-tests

after_success:
  - pip install --upgrade codecov
  - make exec-coverage
  - codecov
  - if [ "$TRAVIS_PULL_REQUEST" == "false" ] && [ "$TRAVIS_BRANCH" == "master" ]; then
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    docker push edxops/credentials:devstack-slim;
    fi
